<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Player Statistics</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .comparison {
            flex: 1;
            background-color: lightblue;
        }
    .player {
        flex: 1;
        display: flex;
    }
    .infos {
        flex: 1; 
        padding: 20px; 
        box-sizing: border-box; 
        background-color: #f0f0f0; 
        min-width: 0; 
    }
    .view {
        flex: 2; 
        padding-left: 3%; 
        padding-right: 3%; 
        padding-top: 20px;
        box-sizing: border-box; 
        background-color: #d0d0d0; 
        min-width: 0; 
        margin-top: 0px; 
    }
    .chart{
      margin-bottom: 20px;
    }
    h1 {
      margin: 0; 
      margin-top: 0; 
    }
    .gameInfo {
      display: grid;
      grid-template-columns: 1fr 2fr; /* 2 columns */
      gap: 10px; /* space between cells */
      max-width: 300px; 
      margin: auto; /* Centered container */
    }
    .label {
      font-weight: bold;
    }
    .captureObjective {
      color: rgb(75, 192, 192); 
    }
    .profitObjective {
      color: rgb(255, 149, 62); 
    }

</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="comparison">
    <h1>Rankings</h1>
    <div class="chartDiv">
      <canvas id="rankingChart" class="chart"></canvas>
    </div>
  </div>
  <div class="player">
    <div class="infos">
      <h1>Player Statistics</h1>
      <select id="playerSelect" onchange="fetchPlayerData()">
        <option value="">Select a player</option>
      </select>
      <div class="gameInfo">
        <div class="label">Player:</div>
        <div id="playerName"></div>

        <div class="label">Objective:</div>
        <div id="playerObjective" class="playerObjective"></div>

        <div class="label">Total capture:</div>
        <div id="playerCapture"></div>

        <div class="label">Capital:</div>
        <div id="playerCapital"></div>
      </div>
      <div id="gameData">
        Player History
        <div class="chartDiv">
          <canvas id="PlayerEvolutionChart" class="chart"></canvas>
        </div>
      </div>
      <div id="highScores">
        Records:
        <div class="gameInfo">
          <div class="label">Best capture:</div>
          <div id="highScoreCapture">ccc</div>
          <div class="label">Best end capital:</div>
          <div id="highScoreCapital">ccc</div>
        </div>
      </div>
      <div id="playerData"></div>

    </div>
    <div class="view">
      <h1>Game summary</h1>
      <div class="chartDiv">
        <div class="chartTitle">Fish stock evolution</div>
        <canvas id="GeneralChart" class="chart"></canvas>
      </div>
      <div class="chartDiv">
        <div class="chartTitle">Capture</div>
        <canvas id="CaptureChart" class="chart"></canvas>
      </div>
      <div class="chartDiv">
        <div class="chartTitle">Economy</div>
        <canvas id="EconomyChart" class="chart"></canvas>
      </div>
    </div>
  </div>
  

  
  <script>
    
    var dataBase;

    var fish_pop;
    var profit;
    var fleet_size;
    var capture;

    var player_name;
    var player_objective;
    var player_capture;
    var player_profit;

    var generalChart;
    var economyChart;
    var captureChart;
    var playerEvolutionChart;

    const playerCaptureEvolution = {};
    const playerCapitalEvolution = {};
    const playerObjectivesList = {};
    const playerBestCapture = {};
    const playerBestProfit = {};

    //************************************************//
    // event triggered at the opening of the web page //
    //************************************************//


    document.addEventListener('DOMContentLoaded', (event) => {
      fetch('/api/players')
        .then(response => response.json())
        .then(data => {
          dataBase = data;

          // sort by timestamp and add simulation number
          dataBase.players.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
          const simulationCounters = {};
          dataBase.players.forEach(player => {
            const playerName = player.username;
            if (!simulationCounters[playerName]) {
                simulationCounters[playerName] = 0;
                playerCaptureEvolution[playerName] = [];
                playerCapitalEvolution[playerName] = [];
                playerObjectivesList[playerName] = [];
            }
            simulationCounters[playerName]++;
            player.simulationNumber = simulationCounters[playerName];
            playerCaptureEvolution[playerName].push(player.total_capture);
            playerCapitalEvolution[playerName].push(player.total_profit);
            playerObjectivesList[playerName].push(player.objective);
            if (!playerBestCapture[playerName] || player.total_capture > playerBestCapture[playerName].score){
              playerBestCapture[playerName] = {score: player.total_capture, index: simulationCounters[playerName]};
            }
            if (!playerBestProfit[playerName] || player.total_profit > playerBestProfit[playerName].score){
              playerBestProfit[playerName] = {score: player.total_profit, index: simulationCounters[playerName]};
            }
          });

          // compute rankings
          const sortedPlayersByCapture = [...dataBase.players].sort((a, b) => a.total_capture - b.total_capture);
          sortedPlayersByCapture.forEach((player, index) => {
          const originalPlayer = dataBase.players.find(p => p.id === player.id); 
              originalPlayer.captureRank = index + 1;  
          });

          // prepare ranking charts
          const playerIdsSortedByCapture = sortedPlayersByCapture.map(player => player.id);
          const totalCapturesSortedByCapture = sortedPlayersByCapture.map(player => player.total_capture);
          const totalProfitsSortedByCapture = sortedPlayersByCapture.map(player => player.total_profit);

          // bar charts

          const minValueProfit = Math.min(0,Math.min(...totalProfitsSortedByCapture));
          const maxValueCapture = Math.max(...totalCapturesSortedByCapture);
          const maxValueProfit =   Math.max(...totalProfitsSortedByCapture);
          
          const minValueCapture = minValueProfit*maxValueCapture/maxValueProfit;

          // const minValue = Math.min(
          //     Math.min(...totalCapturesSortedByCapture), 
          //     Math.min(...totalProfitsSortedByCapture)
          // );

          // // Trouver la valeur maximale commune
          // const maxValue = Math.max(
          //     Math.max(...totalCapturesSortedByCapture), 
          //     Math.max(...totalProfitsSortedByCapture)
          // );

          const ctxRankingChart = document.getElementById('rankingChart').getContext('2d');
          const rankingChart = new Chart(ctxRankingChart, {
              type: 'bar',
              data: {
                  labels: playerIdsSortedByCapture,  // Afficher les IDs des joueurs en abscisse
                  datasets: [
                      {
                          label: 'Total Capture',
                          data: totalCapturesSortedByCapture,  // Valeurs de total_capture
                          backgroundColor: 'rgba(54, 162, 235, 0.6)',  // Bleu
                          borderColor: 'rgba(54, 162, 235, 1)',
                          borderWidth: 1,
                          yAxisID: 'y-left' 
                      },
                      {
                          label: 'Total Profit',
                          data: totalProfitsSortedByCapture,  // Valeurs de total_profit
                          backgroundColor: 'rgba(255, 159, 64, 0.6)',  // Orange
                          borderColor: 'rgba(255, 159, 64, 1)',
                          borderWidth: 1,
                          yAxisID: 'y-right'
                      }
                  ]
              },
              options: {
                  scales: {
                      x: {
                          title: {
                              display: true,
                              text: 'Player IDs'
                          }
                      },
                      'y-left': {
                          beginAtZero: false,  
                          min: minValueCapture,  
                          max: maxValueCapture, 
                          title: {
                              display: true,
                              text: 'Total Capture (tons)'  
                          },
                          position: 'left'
                      },
                      'y-right': {
                          beginAtZero: false,  
                          min: minValueProfit,  
                          max: maxValueProfit,  
                            
                          title: {
                              display: true,
                              text: 'Total Profit ($)'  
                          },
                          position: 'right',  
                          grid: {
                              drawOnChartArea: false  
                          }
                      }
                  }
              }
          });

          // fin chart


          const select = document.getElementById('playerSelect');

          dataBase.players.forEach(player => {
            const option = document.createElement('option');
            option.value = player.id;
            option.textContent = `${player.username} - ${player.timestamp}`;
            option.textContent = `${player.username} - Simulation #${player.simulationNumber} (${player.timestamp})`;
            select.appendChild(option);
          });

          const urlParams = new URLSearchParams(window.location.search);
          const autoSelectId = urlParams.get('autoSelectId');
          if (autoSelectId) {
            select.value = autoSelectId;
            fetchPlayerData();
          }
        });
    });

    //************************************************//
    // event triggered when selecting a game          //
    //************************************************//

    function fetchPlayerData() {
      const select = document.getElementById('playerSelect');
      const playerId = select.value;
     
      if (playerId) {
        player_name = playerId;
        gameData = dataBase.players.find(el => el.id == playerId);
        
        player_name = gameData.username;
        player_objective = gameData.objective;
        player_capture = normalizeCapture(gameData.total_capture)+ " tons";
        player_capital = normalizeProfit(gameData.total_profit)+ " \$";

        
        // populate general infos

        playerName.textContent = player_name;
        playerObjective.textContent = player_objective;
        playerCapture.textContent = player_capture;
        playerCapital.textContent = player_capital;

        // populate high scores

        highScoreCapture.textContent = normalizeCapture(playerBestCapture[player_name].score)
            +' tons (game #'+playerBestCapture[player_name].index+')';
        highScoreCapital.textContent = normalizeProfit(playerBestProfit[player_name].score)
            +' $ (game #'+playerBestProfit[player_name].index+')';


        document.getElementById('playerObjective').classList.remove('captureObjective');
        document.getElementById('playerObjective').classList.remove('profitObjective');
        if (player_objective === "Capture") {
          document.getElementById('playerObjective').classList.add('captureObjective');
        } else {
          document.getElementById('playerObjective').classList.add('profitObjective');
        }

        fish_pop = JSON.parse(gameData.fish_population);
        profit = JSON.parse(gameData.profit);
        capture = JSON.parse(gameData.capture);
        fleet_size = JSON.parse(gameData.ships);

        const playerData = document.getElementById('playerData');
        // playerData.textContent = JSON.stringify(gameData);
       
        // erase previous charts

        if (generalChart) {
          generalChart.destroy();
        }
        if (captureChart) {
          captureChart.destroy();
        }
        if (economyChart) {
          economyChart.destroy();
        }
        if (playerEvolutionChart) {
          playerEvolutionChart.destroy();
        }

        const ctxGeneral = document.getElementById('GeneralChart').getContext('2d');
        generalChart = new Chart(ctxGeneral, {
        type: 'line', 
          data: {
            labels: fish_pop.map((_, index) => `Day ${index + 1}`), 
            datasets: [{
                label: 'Fish stock',
                data: fish_pop.map(el => normalizeCapture(el)), 
                borderColor: 'rgba(45, 191, 82, 1)',
                backgroundColor: 'rgba(45, 191, 82, 0.2)',
                borderWidth: 2,
                fill: true 
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                maxWidth: 800,
                minWidth: 800,
                width: 800,
                title: {
                  display: true,
                  text: 'stock size (tons)' 
                }
              }
            }
          }
        });

        
        const ctxCapture = document.getElementById('CaptureChart').getContext('2d');
        captureChart = new Chart(ctxCapture, {
        type: 'line', 
          data: {
            labels: fish_pop.map((_, index) => `Day ${index + 1}`), 
            datasets: [{
              label: 'Capture',
              data: capture.map(el => normalizeCapture(el)), 
              borderColor: 'rgba(75, 192, 192, 1)',
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              borderWidth: 2,
              fill: true 
            },
            {
              label: 'Fleet size',
              data: fleet_size, 
              borderColor: 'rgba(100, 100, 100, 1)',
              yAxisID: 'y-axis-fleetsize',
              showLine: false, 
              pointRadius: 3, 
              pointHoverRadius: 7 
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Capture (tons)' 
                }
              },
              'y-axis-fleetsize': {
                type: 'linear',
                position: 'right',
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Ships' 
                }
              }
            }
            
          }
        });




        const ctxEconomy = document.getElementById('EconomyChart').getContext('2d');
        economyChart = new Chart(ctxEconomy, {
        type: 'line', 
          data: {
              labels: fish_pop.map((_, index) => `Day ${index + 1}`), 
              datasets: [{
                  label: 'Net profit',
                  data: profit, 
                  borderColor: 'rgba(255, 149, 62, 1)',
                  backgroundColor: 'rgba(255, 149, 62, 0.2)',
                  borderWidth: 2,
                  fill: true 
              },
              {
                  label: 'Fleet size',
                  data: fleet_size, 
                  borderColor: 'rgba(100, 100, 100, 1)',
                  yAxisID: 'y-axis-fleet',
                  showLine: false, 
                  pointRadius: 3, 
                  pointHoverRadius: 7 
              }
            ]
          },
          options: {
            scales: {
              y: {
                  beginAtZero: true,
                  title: {
                      display: true,
                      text: 'Profit ($)' 
                  }
              },
              'y-axis-fleet': {
                type: 'linear',
                position: 'right',
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Ships' 
                }
              }
            }
            
          }
        });

   
        const ctxPlayer = document.getElementById('PlayerEvolutionChart').getContext('2d');
        playerEvolutionChart = new Chart(ctxPlayer, {
          type: 'line',
          data: {
            labels: playerCaptureEvolution[player_name].map((_, index) => `Game ${index + 1}`),
            datasets: [{
              label: 'Total capture',
              data: playerCaptureEvolution[player_name],
              borderColor: 'rgba(75, 192, 192, 1)',
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              borderWidth: 2,
              pointRadius: playerObjectivesList[player_name].map((objective) => objective === 'Capture' ? 5 : 3),
              pointBackgroundColor: playerObjectivesList[player_name].map((objective) => objective === 'Capture' ? 'rgb(75,192,192, 1)' : 'rgba(75, 192, 192, 0.2'),
              pointBorderColor: 'rgba(75, 192, 192, 1)', 
            },
            {
              label: 'End capital',
              data: playerCapitalEvolution[player_name],
              borderColor: 'rgba(255, 149, 62, 1)',
              backgroundColor: 'rgba(255, 149, 62, 0.2)',
              yAxisID: 'y-axis-capital',
              borderWidth: 2,
              pointRadius: playerObjectivesList[player_name].map((objective) => objective === 'Profit' ? 5 : 3),
              pointBackgroundColor: playerObjectivesList[player_name].map((objective) => objective === 'Profit' ? 'rgb(255, 149, 62, 1)' : 'rgba(255, 149, 62, 0.2'),
              pointBorderColor: 'rgba(255, 149, 62, 1)', 
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Capture (tons)'
                }
              },
              'y-axis-capital': {
                type: 'linear',
                position: 'right',
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Capital ($)'
                }
              },
              // x: {
              //   ticks: {
              //     callback: function(value, index) {
              //       return  this.getLabelForValue(value); 
              //     },
              //     color: function(context) {
              //       return playerObjectivesList[player_name][context.index] === 'Capture' ? 'blue' : 'orange'; 
              //     }
              //   }
              // }
            }
          }
        });




      } else {
        document.getElementById('playerData').textContent = '';
      }
    }

  function normalizeCapture(f){
    return Math.floor(f/1000*100)/100;
  }

  function normalizeProfit(f){
    return Math.floor(f*100)/100;
  }
    

  </script>
</body>
</html>
